####
# This is the shared configuration of jobs for quartz
.on_quartz:
  tags:
    - shell
    - quartz
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /_qnone/ || $ON_QUARTZ == "OFF"' #run except if ...
      when: never


####
# Templates
.src_build_on_quartz:
  stage: build
  variables:
    ALLOC_COMMAND: "srun -t 20 -p pdebug -A ${ALLOC_BANK} -N 1 --exclusive --interactive --mpibind=off"
  extends: [.src_build_script, .on_quartz, .src_workflow]
  needs: []

.integration_tests_on_quartz:
  stage: test
  variables:
    BUILD_DIRECTORY: "_serac_build_and_test_*/build-*"
    ALLOC_COMMAND: "salloc -p pdebug -A ${ALLOC_BANK} -N 2 -t 20"
  extends: [.integration_tests_script, .on_quartz, .src_workflow]
  needs: []

.full_build_on_quartz:
  stage: build
  variables:
    ALLOC_COMMAND: "salloc -p pdebug -A ${ALLOC_BANK} -N 1 -c 36 -t 45"
  extends: [.full_build_script, .on_quartz, .full_workflow]
  needs: []
  before_script:
    # LC version of pip is ancient
    - if [[ $(python3 -c 'import pip; print(pip.__version__ < "19.3")') == "True" ]]; then python3 -m pip install --user --upgrade pip; fi


####
# Build jobs

quartz-clang_10_0_0-src:
  variables:
    COMPILER: "clang@10.0.0"
    HOST_CONFIG: "quartz-toss_3_x86_64_ib-${COMPILER}.cmake"
  extends: .src_build_on_quartz

# Only run integration tests on one spec
quartz-clang_10_0_0-integration:
  extends: .integration_tests_on_quartz

quartz-gcc_8_3_1-src:
  variables:
    COMPILER: "gcc@8.3.1"
    HOST_CONFIG: "quartz-toss_3_x86_64_ib-${COMPILER}.cmake"
  extends: .src_build_on_quartz

quartz-clang_10_0_0-full:
  variables:
    COMPILER: "clang@10.0.0"
    SPEC: "--spec=%${COMPILER}"
  extends: .full_build_on_quartz

quartz-gcc_8_3_1-full:
  variables:
    COMPILER: "gcc@8.3.1"
    SPEC: "--spec=%${COMPILER}"
  extends: .full_build_on_quartz
