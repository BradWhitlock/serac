#!/bin/bash
##############################################################################
# Copyright (c) 2019-2021, Lawrence Livermore National Security, LLC and
# other Serac Project Developers. See the top-level LICENSE file for
# details.
#
# SPDX-License-Identifier: (BSD-3-Clause)
##############################################################################

########################
## Test Invocations
#
# TOSS3: salloc -N2 ./ats.sh
# BlueOS: lalloc 2 ./ats.sh
# WSL: ./ats.sh

# Variables used inside of the base test.ats
export ATS_SERAC_BIN_DIR=@SERAC_BIN_DIR@/bin
export ATS_SERAC_REPO_DIR=@SERAC_REPO_DIR@

if [ ! -d "@ATS_DIR@" ]; then
    echo "ERROR: Given ATS_DIR does not exist: @ATS_DIR@"
    exit 1
fi

export ATS_BIN_DIR=@ATS_DIR@/bin

if [ ! -d "$ATS_BIN_DIR" ]; then
    echo "ERROR: Given ATS_DIR does not have a 'bin' directory: @ATS_DIR@"
    exit 1
fi

# Add Serac's and ATS's bin directory to path
export PATH=$ATS_BIN_DIR:$ATS_SERAC_BIN_DIR:$PATH

ATS_EXE=`which ats`

echo "~~~~~~~~~~~~~~~~~~~~~~~~~~"
echo "ATS:      " $ATS_EXE
echo "BIN DIR:  " $ATS_SERAC_BIN_DIR
echo "REPO DIR: " $ATS_SERAC_REPO_DIR
echo "~~~~~~~~~~~~~~~~~~~~~~~~~~"

if [ ! -f "$ATS_EXE" ]; then
    echo "ERROR: ATS executable cannot be found in given ATS_DIR or on system path: @ATS_DIR@"
    exit 1
fi

# Clean-up old run's logs
rm -rf $SYS_TYPE.*

# Clean-up last run's output 
# TODO: add a script to clean up output
#rm -rf $ATS_SERAC_REPO_DIR/tests/integration/*/output

# Run ATS
ats $ATS_SERAC_REPO_DIR/tests/integration/test.ats
